(function(){"use strict";var scripts=document.getElementsByTagName("script");var currentScriptPath=scripts[scripts.length-1].src;if(currentScriptPath.length==0){currentScriptPath=window.installPath+"/ac-angular-usuarios/includes/ac-usuarios.php"}angular.module("acUsuarios",["ngCookies"]).config(["$routeProvider","jwtInterceptorProvider","$httpProvider",function($routeProvider,jwtInterceptorProvider,$httpProvider){jwtInterceptorProvider.tokenGetter=function(store){console.log(store.get(window.appName));return store.get(window.appName)};$httpProvider.interceptors.push("jwtInterceptor")}]).run(function($rootScope,store,jwtHelper,$location,UserVars){$rootScope.$on("$routeChangeStart",function(e,to){if(to&&to.data&&to.data.requiresLogin){if(!store.get(window.appName)){e.preventDefault();$location.path(UserVars.loginPath)}}})}).factory("UserService",UserService).service("UserVars",UserVars);UserService.$inject=["$http","$cookieStore","store","UserVars","$cacheFactory","AcUtils","jwtHelper","auth"];function UserService($http,$cookieStore,store,UserVars,$cacheFactory,AcUtils,jwtHelper,auth){var service={};var url=currentScriptPath.replace("ac-usuarios.js","/includes/ac-usuarios.php");service.getLogged=getLogged;service.getFromToken=getFromToken;service.setLogged=setLogged;service.checkLastLogin=checkLastLogin;service.create=create;service.createFromSocial=createFromSocial;service.remove=remove;service.update=update;service.get=get;service.getDeudores=getDeudores;service.getDeudorById=getDeudorById;service.getById=getById;service.getByParams=getByParams;service.login=login;service.loginFacebook=loginFacebook;service.loginGoogle=loginGoogle;service.logout=logout;service.userExist=userExist;service.forgotPassword=forgotPassword;service.changePassword=changePassword;service.goToPagina=goToPagina;service.next=next;service.prev=prev;return service;function getDeudorById(id,callback){getDeudores(function(data){var response=data.filter(function(elem,index,array){return id=elem.usuario_id})[0];callback(response)})}function getDeudores(callback){return $http.post(url,{"function":"getDeudores"}).success(function(data){callback(data)}).error(function(data){callback(data)})}function getByParams(params,values,exact_match,callback){get(function(data){AcUtils.getByParams(params,values,exact_match,data,callback)})}function remove(usuario_id,callback){return $http.post(url,{"function":"remove",usuario_id:usuario_id}).success(function(data){if(data!=="false"){UserVars.clearCache=true;callback(data)}}).error(function(data){callback(data)})}function get(callback){var urlGet=url+"?function=get";var $httpDefaultCache=$cacheFactory.get("$http");var cachedData=[];if($httpDefaultCache.get(urlGet)!=undefined){if(UserVars.clearCache){$httpDefaultCache.remove(urlGet)}else{cachedData=$httpDefaultCache.get(urlGet);callback(cachedData);return}}return $http.get(urlGet,{cache:true}).success(function(data){$httpDefaultCache.put(urlGet,data);UserVars.clearCache=false;UserVars.paginas=data.length%UserVars.paginacion==0?parseInt(data.length/UserVars.paginacion):parseInt(data.length/UserVars.paginacion)+1;callback(data)}).error(function(data){callback(data);UserVars.clearCache=false})}function getById(id,callback){get(function(data){var response=data.filter(function(elem,index,array){return elem.usuario_id==id})[0];callback(response)})}function checkLastLogin(){}function userExist(mail,callback){return $http.post(url,{"function":"userExist",mail:mail}).success(function(data){callback(data)}).error(function(data){})}function logout(callback){store.remove(window.appName);$cookieStore.remove("user");UserVars.clearCache=true;if(callback!=undefined){callback()}}function login(mail,password,sucursal_id,callback){return $http.post(url,{"function":"login",mail:mail,password:password,sucursal_id:sucursal_id}).success(function(data){if(data!=-1){$cookieStore.put("user",data.user);store.set(window.appName,data.token)}callback(data)}).error(function(data){callback(data)})}var callback_social=function(data){console.log(data)};function loginFacebook(callback){callback_social=callback;auth.signin({popup:true,connections:["facebook"],scope:"openid name email"},onLoginSuccess,onLoginFailed)}function loginGoogle(callback){callback_social=callback;auth.signin({popup:true,connections:["google-oauth2"],scope:"openid name email"},onLoginSuccess,onLoginFailed)}function onLoginSuccess(profile,token){userExist(profile.email,function(data){if(data>0){var user={mail:profile.email};$http.post(url,{"function":"loginSocial",token:token,user:JSON.stringify(user)}).success(function(data){if(data!=-1){$cookieStore.put("user",data.user);store.set(window.appName,data.token)}callback_social(data)}).error(function(data){console.log(data);callback_social(data)})}else{UserVars.user=profile;callback_social(data)}})}function onLoginFailed(data){callback_social(data)}function createFromSocial(usuario,callback){return $http.post(url,{"function":"create",user:JSON.stringify(usuario)}).success(function(data){UserVars.clearCache=true;callback(data)}).error(function(data){UserVars.clearCache=true;callback(data)})}function create(usuario,callback){return $http.post(url,{"function":"create",user:JSON.stringify(usuario)}).success(function(data){UserVars.clearCache=true;callback(data)}).error(function(data){UserVars.clearCache=true;callback(data)})}function getLogged(){var globals=$cookieStore.get("user");if(globals!==undefined){return globals}else{return false}}function getFromToken(){var globals=store.get(window.appName);if(globals!==undefined&&globals!==null){return jwtHelper.decodeToken(globals)}else{return false}}function setLogged(user){$cookieStore.set("user",user)}function changePassword(usuario_id,pass_old,pass_new,callback){return $http.post(url,{"function":"changePassword",usuario_id:usuario_id,pass_old:pass_old,pass_new:pass_new}).success(function(data){UserVars.clearCache=true;callback(data)}).error(function(data){callback(data)})}function update(usuario,callback){return $http.post(url,{"function":"update",user:JSON.stringify(usuario)}).success(function(data){UserVars.clearCache=true;callback(data)}).error(function(data){callback(data)})}function forgotPassword(email,callback){return $http.post(url,{"function":"forgotPassword",email:email}).success(function(data){callback(data)}).error(function(data){callback(data)})}function goToPagina(pagina){if(isNaN(pagina)||pagina<1){UserVars.pagina=1;return UserVars}if(pagina>UserVars.paginas){UserVars.pagina=UserVars.paginas;return UserVars}UserVars.pagina=pagina-1;UserVars.start=UserVars.pagina*UserVars.paginacion;return UserVars}function next(){if(UserVars.pagina+1>UserVars.paginas){return UserVars}UserVars.start=UserVars.pagina*UserVars.paginacion;UserVars.pagina=UserVars.pagina+1;return UserVars}function prev(){if(UserVars.pagina-2<0){return UserVars}UserVars.start=(UserVars.pagina-2)*UserVars.paginacion;UserVars.pagina=UserVars.pagina-1;return UserVars}}UserVars.$inject=[];function UserVars(){this.paginas=1;this.pagina=1;this.paginacion=10;this.start=0;this.user={};this.clearCache=true;this.loginPath="/login"}})();